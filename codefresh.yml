version: '1.0'
mode: parallel
stages:
- build-base
- test-release

steps:
  build_base_image:
    type: build
    stage: build-base
    title: Build base target Docker image
    image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
    tag: base
    target: base
    when:
      steps:
      - name: main_clone
        on:
        - success

  test_release:
    type: parallel
    stage: test-release
    when:
      steps:
      - name: build_base_image
        on:
        - success
    steps:
      build_test:
        type: build
        title: Build test image
        image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
        tag: test
        target: test
      run_test:
        title: Run tests
        image: ${{build_test}}
        commands:
        - cargo fmt -v --all -- --check
        - cargo clippy -v --locked --all
        - cargo test -v --locked --all
        when:
          steps:
          - name: build_test
            on:
            - success

      build:
        type: build
        title: Build image in debug mode
        image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
        tag: build
        target: build

      build_release:
        type: build
        title: Build release image containing binary
        image_name: ${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}
        tag: ${{CF_BRANCH}}
        target: release
